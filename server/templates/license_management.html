{% extends 'base_admin.html' %}

{% block title %}Lisans Yönetimi{% endblock %}

{% block content %}
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-key"></i>
            Lisans Yönetimi
        </h1>
        <p class="page-description">Sistem lisansınızı yönetin ve doğrulayın</p>
    </div>

    {% if message %}
    <div class="alert-banner {% if 'başarıyla' in message or 'valid' in license_status %}alert-success{% else %}alert-error{% endif %}">
        <i class="fas {% if 'başarıyla' in message or 'valid' in license_status %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}"></i>
        <span>{{ message }}</span>
    </div>
    {% endif %}

    <!-- Lisans Kayıt Formu -->
    <form method="POST" action="{{ url_for('license_management') }}">
        <div class="card">
            <div class="card-header-modern">
                <h3>
                    <i class="fas fa-key"></i>
                    Lisans Anahtarı
                </h3>
            </div>
            <div class="card-body-modern">
                <div class="form-grid-modern">
                    <!-- Lisans Anahtarı -->
                    <div class="form-group-modern full-width">
                        <label class="form-label-modern">
                            <i class="fas fa-fingerprint"></i>
                            <span>Ana Lisans Anahtarı</span>
                        </label>
                        <input type="text" id="license_key" name="license_key" value="{{ license_key }}" placeholder="KA-STD-XXXX-XXXX" required class="form-input-modern license-input">
                        <div class="input-hint">
                            <i class="fas fa-info-circle"></i>
                            Lisans anahtarınızı buraya girin
                        </div>
                    </div>

                    <!-- Lisans Durumu -->
                    <div class="form-group-modern full-width">
                        <label class="form-label-modern">
                            <i class="fas fa-shield-alt"></i>
                            <span>Lisans Durumu</span>
                        </label>
                        <div class="status-badge-container">
                            {% if license_status == 'valid' %}
                                <span class="status-badge status-active">
                                    <i class="fas fa-check-circle"></i>
                                    AKTİF
                                </span>
                            {% elif license_status %}
                                <span class="status-badge status-invalid">
                                    <i class="fas fa-times-circle"></i>
                                    GEÇERSİZ
                                </span>
                                {% if license_reason %}
                                <div class="status-reason">{{ license_reason }}</div>
                                {% endif %}
                            {% else %}
                                <span class="status-badge status-unknown">
                                    <i class="fas fa-question-circle"></i>
                                    BİLİNMİYOR
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions-inline">
                    <button type="submit" name="action" value="save_and_check" class="btn btn-primary-modern">
                        <i class="fas fa-save"></i> Kaydet ve Kontrol Et
                    </button>
                    <button type="submit" name="action" value="check_only" class="btn btn-secondary-modern">
                        <i class="fas fa-sync-alt"></i> Sadece Durumu Kontrol Et
                    </button>
                </div>
            </div>
        </div>
    </form>

    <!-- Sistem Bilgileri -->
    <div class="card">
        <div class="card-header-modern">
            <h3>
                <i class="fas fa-server"></i>
                Sistem Bilgileri
            </h3>
        </div>
        <div class="card-body-modern">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-microchip"></i>
                        Donanım Kimliği (HWID)
                    </div>
                    <div class="info-value hwid-value">{{ server_hwid or 'Alınamadı' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-globe"></i>
                        Sunucu IP Adresi
                    </div>
                    <div class="info-value">{{ server_public_ip or 'Alınamadı' }}</div>
                </div>
                {% if last_check_time %}
                <div class="info-item full-width">
                    <div class="info-label">
                        <i class="fas fa-clock"></i>
                        Son Kontrol Zamanı
                    </div>
                    <div class="info-value">{{ last_check_time.strftime('%d.%m.%Y %H:%M:%S') }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Lisans Detayları -->
    {% if license_key and full_license_data and full_license_data.get('license_details') %}
    {% set details = full_license_data.license_details %}
    
    <div class="card">
        <div class="card-header-modern">
            <h3>
                <i class="fas fa-file-contract"></i>
                Lisans Detayları
            </h3>
        </div>
        <div class="card-body-modern">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-key"></i>
                        Lisans Anahtarı
                    </div>
                    <div class="info-value license-key-display">{{ details.get('license_key', 'N/A') }}</div>
                </div>

                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-layer-group"></i>
                        Lisans Tipi
                    </div>
                    <div class="info-value">
                        <span class="type-badge">{{ details.get('license_type', 'N/A') }}</span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-calendar-alt"></i>
                        Başlangıç Tarihi
                    </div>
                    <div class="info-value">{{ details.get('start_date', 'N/A') }}</div>
                </div>

                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-calendar-check"></i>
                        Bitiş Tarihi
                    </div>
                    <div class="info-value">{{ details.get('end_date', 'N/A') }}</div>
                </div>

                {% if details.get('days_remaining') %}
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-hourglass-half"></i>
                        Kalan Gün
                    </div>
                    <div class="info-value days-remaining">
                        <span class="{% if details.get('days_remaining')|int < 30 %}text-warning{% elif details.get('days_remaining')|int < 7 %}text-danger{% else %}text-success{% endif %}">
                            {{ details.get('days_remaining') }} gün
                        </span>
                    </div>
                </div>
                {% endif %}

                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-toggle-on"></i>
                        Durum
                    </div>
                    <div class="info-value">
                        <span class="status-badge {% if details.get('is_active') == '1' or details.get('is_active') == 1 %}status-active{% else %}status-inactive{% endif %}">
                            {% if details.get('is_active') == '1' or details.get('is_active') == 1 %}
                                <i class="fas fa-check-circle"></i> Aktif
                            {% else %}
                                <i class="fas fa-times-circle"></i> Pasif
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Müşteri Bilgileri -->
    {% if details.get('customer_name') or details.get('customer_email') or details.get('customer_phone') or details.get('customer_company') %}
    <div class="card">
        <div class="card-header-modern">
            <h3>
                <i class="fas fa-user-tie"></i>
                Müşteri Bilgileri
            </h3>
        </div>
        <div class="card-body-modern">
            <div class="customer-profile">
                <div class="customer-avatar">
                    <i class="fas fa-building"></i>
                </div>
                <div class="customer-details">
                    <h4>{{ details.customer_company or details.customer_name or 'Müşteri' }}</h4>
                    {% if details.customer_company and details.customer_name %}
                    <p class="customer-subtitle">{{ details.customer_name }}</p>
                    {% endif %}
                </div>
            </div>

            <div class="info-grid" style="margin-top: 2rem;">
                {% if details.customer_name %}
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-user"></i>
                        Ad Soyad
                    </div>
                    <div class="info-value">{{ details.customer_name }}</div>
                </div>
                {% endif %}

                {% if details.customer_email %}
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-envelope"></i>
                        E-posta
                    </div>
                    <div class="info-value">
                        <a href="mailto:{{ details.customer_email }}" class="email-link">{{ details.customer_email }}</a>
                    </div>
                </div>
                {% endif %}

                {% if details.customer_phone %}
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-phone"></i>
                        Telefon
                    </div>
                    <div class="info-value">
                        <a href="tel:{{ details.customer_phone }}" class="phone-link">{{ details.customer_phone }}</a>
                    </div>
                </div>
                {% endif %}

                {% if details.customer_company %}
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-building"></i>
                        Şirket
                    </div>
                    <div class="info-value">{{ details.customer_company }}</div>
                </div>
                {% endif %}

                {% if details.get('customer_address') %}
                <div class="info-item full-width">
                    <div class="info-label">
                        <i class="fas fa-map-marker-alt"></i>
                        Adres
                    </div>
                    <div class="info-value">{{ details.customer_address }}</div>
                </div>
                {% endif %}

                {% if details.get('customer_city') %}
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-city"></i>
                        Şehir
                    </div>
                    <div class="info-value">{{ details.customer_city }}</div>
                </div>
                {% endif %}

                {% if details.get('customer_country') %}
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-flag"></i>
                        Ülke
                    </div>
                    <div class="info-value">{{ details.customer_country }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Ek Lisans Bilgileri -->
    {% if details.get('max_devices') or details.get('features') or details.get('notes') %}
    <div class="card">
        <div class="card-header-modern">
            <h3>
                <i class="fas fa-info-circle"></i>
                Ek Bilgiler
            </h3>
        </div>
        <div class="card-body-modern">
            <div class="info-grid">
                {% if details.get('max_devices') %}
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-laptop"></i>
                        Maksimum Cihaz Sayısı
                    </div>
                    <div class="info-value">{{ details.max_devices }}</div>
                </div>
                {% endif %}

                {% if details.get('features') %}
                <div class="info-item full-width">
                    <div class="info-label">
                        <i class="fas fa-star"></i>
                        Özellikler
                    </div>
                    <div class="info-value">{{ details.features }}</div>
                </div>
                {% endif %}

                {% if details.get('notes') %}
                <div class="info-item full-width">
                    <div class="info-label">
                        <i class="fas fa-sticky-note"></i>
                        Notlar
                    </div>
                    <div class="info-value">{{ details.notes }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
{% endblock %}

{% block head %}
<style>
    /* Alert Banner */
    .alert-banner {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
        font-weight: 500;
    }

    .alert-banner i {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .alert-success {
        background: rgba(16, 185, 129, 0.15);
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: #10b981;
    }

    .alert-error {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
    }

    /* Card Styles */
    .card-header-modern {
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.25) 100%);
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-header-modern h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--foreground);
        display: flex;
        align-items: center;
        gap: 0.625rem;
        margin: 0;
    }

    .card-header-modern h3 i {
        color: #64748b;
        font-size: 1.125rem;
    }

    .card-body-modern {
        padding: 2rem;
    }

    /* Form Grid Modern */
    .form-grid-modern {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    .form-group-modern.full-width {
        grid-column: 1 / -1;
    }

    .form-label-modern {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
        font-size: 1rem;
        color: var(--foreground);
    }

    .form-input-modern {
        width: 100%;
        padding: 0.875rem 1rem;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        color: var(--foreground);
        font-size: 0.9375rem;
        transition: all 0.3s;
        font-family: 'Poppins', sans-serif;
    }

    .form-input-modern:focus {
        outline: none;
        border-color: #64748b;
        background: rgba(0, 0, 0, 0.3);
        box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.1);
    }

    .input-hint {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--muted-foreground);
        margin-top: 0.5rem;
    }

    /* Status Badges */
    .status-badge-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 600;
        font-size: 0.875rem;
        width: fit-content;
    }

    .status-badge.status-active {
        background: rgba(16, 185, 129, 0.15);
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: #10b981;
    }

    .status-badge.status-invalid {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
    }

    .status-badge.status-unknown {
        background: rgba(148, 163, 184, 0.15);
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: #94a3b8;
    }

    .status-badge.status-inactive {
        background: rgba(148, 163, 184, 0.15);
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: #94a3b8;
    }

    .status-reason {
        color: var(--muted-foreground);
        font-size: 0.875rem;
        padding: 0.5rem 0;
    }

    /* Form Actions */
    .form-actions-inline {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .btn-primary-modern,
    .btn-secondary-modern {
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: 0.5rem;
        color: white;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s;
    }

    .btn-primary-modern {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    }

    .btn-primary-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(100, 116, 139, 0.4);
    }

    .btn-secondary-modern {
        background: rgba(100, 116, 139, 0.2);
        border: 1px solid rgba(100, 116, 139, 0.3);
    }

    .btn-secondary-modern:hover {
        background: rgba(100, 116, 139, 0.3);
    }

    /* Info Grid */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .info-item.full-width {
        grid-column: 1 / -1;
    }

    .info-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--muted-foreground);
        font-weight: 500;
    }

    .info-label i {
        color: #64748b;
    }

    .info-value {
        font-size: 1rem;
        color: var(--foreground);
        font-weight: 600;
    }

    .hwid-value {
        font-family: 'Courier New', monospace;
        background: rgba(100, 116, 139, 0.2);
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid rgba(100, 116, 139, 0.3);
        width: fit-content;
    }

    .license-key-display {
        font-family: 'Courier New', monospace;
        background: rgba(100, 116, 139, 0.2);
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid rgba(100, 116, 139, 0.3);
        width: fit-content;
    }

    .type-badge {
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: #3b82f6;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .text-warning {
        color: #f59e0b;
    }

    .text-danger {
        color: #ef4444;
    }

    .text-success {
        color: #10b981;
    }

    /* Customer Profile */
    .customer-profile {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .customer-avatar {
        width: 4rem;
        height: 4rem;
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        flex-shrink: 0;
    }

    .customer-details h4 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--foreground);
    }

    .customer-subtitle {
        margin: 0.5rem 0 0 0;
        color: var(--muted-foreground);
        font-size: 1rem;
    }

    .email-link,
    .phone-link {
        color: #3b82f6;
        text-decoration: none;
        transition: color 0.3s;
    }

    .email-link:hover,
    .phone-link:hover {
        color: #2563eb;
        text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr;
        }

        .form-actions-inline {
            flex-direction: column;
        }

        .btn-primary-modern,
        .btn-secondary-modern {
            width: 100%;
            justify-content: center;
        }

        .customer-profile {
            flex-direction: column;
            text-align: center;
        }
    }
</style>
{% endblock %}
