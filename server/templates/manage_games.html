
{% extends 'base_admin.html' %}

{% block title %}Oyun Yönetimi{% endblock %}

{% block content %}
    <!-- Sayfa Başlığı ve Kontroller -->
    <header class="header">
        <h1 style="font-size: 20px; font-weight: 600; display: flex; align-items: center; gap: 12px; color: var(--text-secondary);">
            <i class="fas fa-gamepad" style="color: var(--accent-red);"></i>
            Oyun Yönetimi
        </h1>
        <div class="header-controls">
            <a href="{{ url_for('add_game') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Yeni Oyun Ekle
            </a>
            <!-- Gelecek Aktif/Pasif Buton Alanı -->
            <div class="future-toggle-area">
                <!-- Bu alan gelecekte toggle butonu için rezerve edildi -->
            </div>
        </div>
    </header>


    <!-- Filtre Bölümü -->
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 12px; color: var(--text-secondary);">
                <i class="fas fa-filter" style="color: var(--accent-red);"></i>
                Filtreler
            </h2>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('list_games') }}" class="filters-form" id="filtersForm">
                <div class="filters-grid">
                    <!-- Oyun Adı Arama -->
                    <div class="filter-group">
                        <label for="search">
                            <i class="fas fa-search"></i> Oyun Adı
                        </label>
                        <input type="text"
                               id="search"
                               name="q"
                               placeholder="Oyun adını yazın..."
                               value="{{ search_query or '' }}"
                               class="filter-input">
                    </div>

                    <!-- Kategori Filtresi -->
                    <div class="filter-group">
                        <label for="category">
                            <i class="fas fa-folder"></i> Kategori
                        </label>
                        <div class="modern-select">
                            <div class="modern-select-trigger" data-target="category">
                                <span class="modern-select-text">{% if category_filter %}{% for cat in categories %}{% if cat.id|string == category_filter|string %}{{ cat.name }}{% endif %}{% endfor %}{% else %}Tüm Kategoriler{% endif %}</span>
                                <div class="modern-select-arrow"></div>
                            </div>
                            <div class="modern-select-options">
                                <div class="modern-select-option {% if not category_filter %}selected{% endif %}" data-value="">Tüm Kategoriler</div>
                                {% for cat in categories %}
                                    <div class="modern-select-option {% if category_filter|string == cat.id|string %}selected{% endif %}" data-value="{{ cat.id }}">{{ cat.name }}</div>
                                {% endfor %}
                            </div>
                            <select id="category" name="category" class="modern-select-native">
                                <option value="">Tüm Kategoriler</option>
                                {% for cat in categories %}
                                    <option value="{{ cat.id }}" {% if category_filter|string == cat.id|string %}selected{% endif %}>{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Çıkış Yılı Filtresi -->
                    <div class="filter-group">
                        <label for="year">
                            <i class="fas fa-calendar"></i> Çıkış Yılı
                        </label>
                        <div class="modern-select">
                            <div class="modern-select-trigger" data-target="year">
                                <span class="modern-select-text">{% if year_filter %}{{ year_filter }}{% else %}Tüm Yıllar{% endif %}</span>
                                <div class="modern-select-arrow"></div>
                            </div>
                            <div class="modern-select-options">
                                <div class="modern-select-option {% if not year_filter %}selected{% endif %}" data-value="">Tüm Yıllar</div>
                                {% for year in years %}
                                    {% if year.cikis_yili %}
                                        <div class="modern-select-option {% if year_filter == year.cikis_yili %}selected{% endif %}" data-value="{{ year.cikis_yili }}">{{ year.cikis_yili }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <select id="year" name="year" class="modern-select-native">
                                <option value="">Tüm Yıllar</option>
                                {% for year in years %}
                                    {% if year.cikis_yili %}
                                        <option value="{{ year.cikis_yili }}" {% if year_filter == year.cikis_yili %}selected{% endif %}>{{ year.cikis_yili }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Dil Filtresi -->
                    <div class="filter-group">
                        <label for="language">
                            <i class="fas fa-globe"></i> Dil
                        </label>
                        <div class="modern-select">
                            <div class="modern-select-trigger" data-target="language">
                                <span class="modern-select-text">{% if language_filter %}{{ language_filter }}{% else %}Tüm Diller{% endif %}</span>
                                <div class="modern-select-arrow"></div>
                            </div>
                            <div class="modern-select-options">
                                <div class="modern-select-option {% if not language_filter %}selected{% endif %}" data-value="">Tüm Diller</div>
                                {% for lang in languages %}
                                    {% if lang.oyun_dili %}
                                        <div class="modern-select-option {% if language_filter == lang.oyun_dili %}selected{% endif %}" data-value="{{ lang.oyun_dili }}">{{ lang.oyun_dili }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <select id="language" name="language" class="modern-select-native">
                                <option value="">Tüm Diller</option>
                                {% for lang in languages %}
                                    {% if lang.oyun_dili %}
                                        <option value="{{ lang.oyun_dili }}" {% if language_filter == lang.oyun_dili %}selected{% endif %}>{{ lang.oyun_dili }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Filtre Sonuçları ve Temizle Butonu -->
                <div class="filter-results">
                    {% if search_query or category_filter or year_filter or language_filter %}
                        <button type="button" class="btn-clear-filters" onclick="clearAllFilters()">
                            <i class="fas fa-times"></i> Filtreleri Temizle
                        </button>
                    {% endif %}
                </div>

                <!-- Gizli alanlar -->
                <input type="hidden" name="page" value="1">
                <input type="hidden" name="per_page" value="{{ per_page }}">
            </form>
        </div>
    </div>

    <!-- Oyun Grid Listesi -->
    {% if games %}
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 12px; color: var(--text-secondary);">
                <i class="fas fa-gamepad" style="color: var(--accent-red);"></i>
                Tüm Oyunlar
            </h2>
        </div>
        <div class="card-body">
            <div class="games-grid">
                {% for game in games %}
                <div class="game-card">
                    <div class="game-poster">
                        {% if game.cover_image %}
                            <img src="{{ url_for('static', filename='images/covers/' + game.cover_image) }}"
                                 alt="{{ game.oyun_adi }}"
                                 onerror="this.src='{{ url_for('static', filename='images/covers/default-cover.jpg') }}'">
                        {% else %}
                            <div class="no-poster">
                                <i class="fas fa-gamepad"></i>
                                <span>Poster Yok</span>
                            </div>
                        {% endif %}
                        
                        <!-- Hover Actions -->
                        <div class="game-actions">
                            {% if game.id %}
                            <a href="{{ url_for('edit_game', game_id=game.id) }}" class="action-btn btn-icon btn-edit-new" title="Düzenle">
                                <i class="fas fa-pencil-alt"></i>
                            </a>
                            <form action="{{ url_for('delete_game', game_id=game.id) }}" method="POST" class="delete-form"
                                  onsubmit="return confirm('{{ game.oyun_adi }} oyununu silmek istediğine emin misin?');">
                                <button type="submit" class="action-btn btn-icon btn-delete" title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            {% else %}
                            <span class="action-btn disabled" title="ID eksik">
                                <i class="fas fa-exclamation-triangle"></i>
                            </span>
                            {% endif %}
                        </div>

                        <!-- Oyun Bilgi Overlay -->
                        <div class="game-info-overlay">
                            <div class="game-categories">
                                {% if game.category_names %}
                                    {% for category in game.category_names.split(',')[:2] %}
                                        <span class="category-tag">{{ category.strip() }}</span>
                                    {% endfor %}
                                    {% if game.category_names.split(',')|length > 2 %}
                                        <span class="category-tag more">+{{ game.category_names.split(',')|length - 2 }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="category-tag no-category">Kategorisiz</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-title" style="text-align: center;">
                        <h3 style="color: var(--text-secondary);">{{ game.oyun_adi }}</h3>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Sayfalama -->
    {% if total_pages > 1 %}
        <div class="pagination-wrapper" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div style="display: flex; flex-direction: column; gap: 15px; flex: 1;">
                <div class="pagination-nav">
                    {% if has_prev %}
                        <a href="{{ url_for('list_games', page=1, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                           class="pagination-btn" title="İlk Sayfa">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                        <a href="{{ url_for('list_games', page=page-1, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                           class="pagination-btn">
                            <i class="fas fa-chevron-left"></i> Önceki
                        </a>
                    {% endif %}
                    
                    <div class="pagination-numbers">
                        {% set start_page = [1, page - 2]|max %}
                        {% set end_page = [total_pages, page + 2]|min %}
                        
                        {% if start_page > 1 %}
                            <a href="{{ url_for('list_games', page=1, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                               class="pagination-number">1</a>
                            {% if start_page > 2 %}
                                <span class="pagination-dots">...</span>
                            {% endif %}
                        {% endif %}
                        
                        {% for p in range(start_page, end_page + 1) %}
                            <a href="{{ url_for('list_games', page=p, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                               class="pagination-number {% if p == page %}active{% endif %}">{{ p }}</a>
                        {% endfor %}
                        
                        {% if end_page < total_pages %}
                            {% if end_page < total_pages - 1 %}
                                <span class="pagination-dots">...</span>
                            {% endif %}
                            <a href="{{ url_for('list_games', page=total_pages, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                               class="pagination-number">{{ total_pages }}</a>
                        {% endif %}
                    </div>
                    
                    {% if has_next %}
                        <a href="{{ url_for('list_games', page=page+1, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                           class="pagination-btn">
                            Sonraki <i class="fas fa-chevron-right"></i>
                        </a>
                        <a href="{{ url_for('list_games', page=total_pages, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                           class="pagination-btn" title="Son Sayfa">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    {% endif %}
                </div>
                
                <div class="pagination-info">
                    <span style="color: var(--text-secondary);">{{ ((page-1) * per_page + 1) }} - {{ [page * per_page, total_games]|min }} arası,
                          toplam {{ total_pages }} sayfa, {{ total_games }} oyun</span>
                </div>
            </div>
            
            <div class="page-size-selector-bottom" style="display: flex; align-items: center; gap: 12px;">
                <span class="page-size-label" style="color: var(--text-secondary);">Sayfa Boyutu:</span>
                <div class="page-size-boxes">
                    <div class="page-size-box {% if per_page == 8 %}active{% endif %}" onclick="changePageSize(8)">8</div>
                    <div class="page-size-box {% if per_page == 16 %}active{% endif %}" onclick="changePageSize(16)">16</div>
                    <div class="page-size-box {% if per_page == 32 %}active{% endif %}" onclick="changePageSize(32)">32</div>
                    <div class="page-size-box {% if per_page == 48 %}active{% endif %}" onclick="changePageSize(48)">48</div>
                </div>
            </div>
        </div>
    {% endif %}

    {% else %}
    <!-- Boş Durum -->
    <div class="empty-state">
        <i class="fas fa-search"></i>
        <h3 style="color: var(--text-secondary);">Oyun Bulunamadı</h3>
        {% if search_query or category_filter or year_filter or language_filter %}
            <p style="color: var(--text-secondary);">Filtreleme kriterlerinizle eşleşen oyun bulunamadı.</p>
            <button type="button" class="btn btn-secondary" onclick="clearAllFilters()">
                <i class="fas fa-times"></i> Filtreleri Temizle
            </button>
        {% else %}
            <p style="color: var(--text-secondary);">Henüz hiç oyun eklenmemiş.</p>
            <a href="{{ url_for('add_game') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> İlk Oyunu Ekle
            </a>
        {% endif %}
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Modern Dropdown Fonksiyonalitesi
    const modernSelects = document.querySelectorAll('.modern-select');
    
    // Native select'leri gizle
    document.querySelectorAll('.modern-select select').forEach(select => {
        select.style.display = 'none';
    });
    
    modernSelects.forEach(selectContainer => {
        const trigger = selectContainer.querySelector('.modern-select-trigger');
        const options = selectContainer.querySelector('.modern-select-options');
        const optionElements = selectContainer.querySelectorAll('.modern-select-option');
        const textElement = selectContainer.querySelector('.modern-select-text');
        const nativeSelect = selectContainer.querySelector('.modern-select-native');
        
        // Dropdown açma/kapama
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            
            // Diğer açık dropdown'ları kapat
            modernSelects.forEach(otherSelect => {
                if (otherSelect !== selectContainer) {
                    otherSelect.querySelector('.modern-select-trigger').classList.remove('active');
                    otherSelect.querySelector('.modern-select-options').classList.remove('active');
                }
            });
            
            trigger.classList.toggle('active');
            options.classList.toggle('active');
        });
        
        // Seçenek seçimi
        optionElements.forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                
                const value = option.dataset.value;
                const text = option.textContent.trim();
                
                // Seçili durumunu güncelle
                optionElements.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                
                // Görsel metni güncelle
                textElement.textContent = text;
                
                // Native select'i güncelle
                nativeSelect.value = value;
                
                // Dropdown'ı kapat
                trigger.classList.remove('active');
                options.classList.remove('active');
                
                // Form submit
                const form = document.getElementById('filtersForm');
                const pageInput = form.querySelector('input[name="page"]');
                if (pageInput) pageInput.value = 1;
                form.submit();
            });
        });
    });
    
    // Dışarı tıklayınca kapat
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.modern-select')) {
            modernSelects.forEach(selectContainer => {
                const trigger = selectContainer.querySelector('.modern-select-trigger');
                const options = selectContainer.querySelector('.modern-select-options');
                trigger.classList.remove('active');
                options.classList.remove('active');
            });
        }
    });

    // Geleneksel filtre inputları için
    const filterInputs = document.querySelectorAll('.filter-input');
    const form = document.getElementById('filtersForm');
    let filterTimeout;

    filterInputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                // Sayfa numarasını 1'e sıfırla
                const pageInput = form.querySelector('input[name="page"]');
                if (pageInput) pageInput.value = 1;
                
                form.submit();
            }, 500);
        });
    });
});

// Sayfa boyutu değiştirme
function changePageSize(size) {
    const form = document.getElementById('filtersForm');
    const perPageInput = form.querySelector('input[name="per_page"]');
    const pageInput = form.querySelector('input[name="page"]');
    
    if (perPageInput) perPageInput.value = size;
    if (pageInput) pageInput.value = 1; // Sayfa 1'e dön
    
    // Aktif sınıfını güncelle
    document.querySelectorAll('.page-size-box').forEach(box => {
        box.classList.remove('active');
    });
    event.target.classList.add('active');
    
    form.submit();
}

// Tüm filtreleri temizle
function clearAllFilters() {
    const url = new URL(window.location.href);
    url.searchParams.delete('q');
    url.searchParams.delete('category');
    url.searchParams.delete('year');
    url.searchParams.delete('language');
    url.searchParams.set('page', '1');
    
    window.location.href = url.toString();
}
</script>
{% endblock %}