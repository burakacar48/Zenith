
{% extends 'base_admin.html' %}

{% block title %}Oyun Yönetimi{% endblock %}

{% block content %}
    <div class="page-header">
        <h1 class="page-title">Oyun Yönetimi</h1>
        <p class="page-description">Tüm oyunlarınızı burada yönetebilirsiniz</p>
    </div>

    <!-- Filtre Bölümü -->
    <div class="filters-section">
            <form method="GET" action="{{ url_for('list_games') }}" class="filters-form" id="filtersForm">
                <div class="filters-grid">
                    <!-- Oyun Adı Arama -->
                    <div class="filter-group">
                        <label for="search" class="filter-label">Oyun Adı</label>
                        <input type="text"
                               id="search"
                               name="q"
                               placeholder="Oyun adını yazın..."
                               value="{{ search_query or '' }}"
                               class="filter-input">
                    </div>

                    <!-- Kategori Filtresi -->
                    <div class="filter-group">
                        <label for="category" class="filter-label">Kategori</label>
                        <select id="category" name="category" class="filter-select">
                            <option value="">Tüm Kategoriler</option>
                            {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if category_filter|string == cat.id|string %}selected{% endif %}>{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Çıkış Yılı Filtresi -->
                    <div class="filter-group">
                        <label for="year" class="filter-label">Çıkış Yılı</label>
                        <select id="year" name="year" class="filter-select">
                            <option value="">Tüm Yıllar</option>
                            {% for year in years %}
                                {% if year.cikis_yili %}
                                    <option value="{{ year.cikis_yili }}" {% if year_filter == year.cikis_yili %}selected{% endif %}>{{ year.cikis_yili }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Dil Filtresi -->
                    <div class="filter-group">
                        <label for="language" class="filter-label">Dil</label>
                        <select id="language" name="language" class="filter-select">
                            <option value="">Tüm Diller</option>
                            {% for lang in languages %}
                                {% if lang.oyun_dili %}
                                    <option value="{{ lang.oyun_dili }}" {% if language_filter == lang.oyun_dili %}selected{% endif %}>{{ lang.oyun_dili }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Filtre Butonları -->
                <div class="filter-actions">
                    {% if search_query or category_filter or year_filter or language_filter %}
                        <button type="button" class="filter-btn filter-btn-secondary" onclick="clearAllFilters()">
                            <i class="fas fa-times"></i> Filtreleri Temizle
                        </button>
                    {% endif %}
                    <button type="submit" class="filter-btn filter-btn-primary">
                        <i class="fas fa-search"></i> Filtrele
                    </button>
                </div>

                <!-- Gizli alanlar -->
                <input type="hidden" name="page" value="1">
                <input type="hidden" name="per_page" value="{{ per_page }}">
            </form>
    </div>

    <!-- Oyun Grid Listesi -->
    {% if games %}
    <div class="section">
        <div class="games-grid">
        {% for game in games %}
        <div class="game-card {{ 'inactive-game' if (game.is_active != 1) else '' }}">
            <div class="game-card-actions">
                {% if game.id %}
                <a href="{{ url_for('edit_game', game_id=game.id) }}" class="game-card-action-btn edit" title="Düzenle">
                    <i class="fas fa-pencil-alt"></i>
                </a>
                <button type="button" class="game-card-action-btn toggle-status {{ 'active' if game.is_active else 'inactive' }}"
                        onclick="toggleGameStatus({{ game.id }})"
                        title="{{ 'Pasif Yap' if game.is_active else 'Aktif Yap' }}">
                    <i class="fas {{ 'fa-eye' if game.is_active else 'fa-eye-slash' }}"></i>
                </button>
                <form action="{{ url_for('delete_game', game_id=game.id) }}" method="POST" style="display: inline;"
                      onsubmit="return confirm('{{ game.oyun_adi }} oyununu silmek istediğinize emin misiniz?');">
                    <button type="submit" class="game-card-action-btn delete" title="Sil">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
                {% endif %}
            </div>
            {% if game.cover_image %}
                <img src="{{ url_for('static', filename='images/covers/' + game.cover_image) }}"
                     alt="{{ game.oyun_adi }}"
                     class="game-card-cover"
                     onerror="this.src='{{ url_for('static', filename='images/covers/default-cover.jpg') }}'">
            {% else %}
                <img src="{{ url_for('static', filename='images/covers/default-cover.jpg') }}"
                     alt="{{ game.oyun_adi }}"
                     class="game-card-cover">
            {% endif %}
            <div class="game-card-content">
                <div class="game-card-title">{{ game.oyun_adi }}</div>
                <div class="game-card-category">
                    {% if game.category_names %}
                        {% set categories = game.category_names.split(',') %}
                        {{ categories[0].strip() }}
                        {% if categories|length > 1 %}
                            {% if categories|length > 2 %}
                                , {{ categories[1].strip() }} <span style="opacity: 0.6;">+{{ categories|length - 2 }}</span>
                            {% else %}
                                , {{ categories[1].strip() }}
                            {% endif %}
                        {% endif %}
                    {% else %}
                        Kategorisiz
                    {% endif %}
                </div>
                <div class="game-card-stats">
                    <span class="badge {{ 'active' if game.is_active else 'inactive' }}">
                        {{ 'Aktif' if game.is_active else 'Pasif' }}
                    </span>
                    <span class="game-card-clicks">{{ game.play_count or 0 }} kez oynandı</span>
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
    </div>

    <!-- Sayfalama -->
    {% if total_pages > 1 %}
        <div class="pagination-wrapper" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div style="display: flex; flex-direction: column; gap: 15px; flex: 1;">
                <div class="pagination-nav">
                    {% if has_prev %}
                        <a href="{{ url_for('list_games', page=1, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                           class="pagination-btn" title="İlk Sayfa">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                        <a href="{{ url_for('list_games', page=page-1, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                           class="pagination-btn">
                            <i class="fas fa-chevron-left"></i> Önceki
                        </a>
                    {% endif %}
                    
                    <div class="pagination-numbers">
                        {% set start_page = [1, page - 2]|max %}
                        {% set end_page = [total_pages, page + 2]|min %}
                        
                        {% if start_page > 1 %}
                            <a href="{{ url_for('list_games', page=1, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                               class="pagination-number">1</a>
                            {% if start_page > 2 %}
                                <span class="pagination-dots">...</span>
                            {% endif %}
                        {% endif %}
                        
                        {% for p in range(start_page, end_page + 1) %}
                            <a href="{{ url_for('list_games', page=p, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                               class="pagination-number {% if p == page %}active{% endif %}">{{ p }}</a>
                        {% endfor %}
                        
                        {% if end_page < total_pages %}
                            {% if end_page < total_pages - 1 %}
                                <span class="pagination-dots">...</span>
                            {% endif %}
                            <a href="{{ url_for('list_games', page=total_pages, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                               class="pagination-number">{{ total_pages }}</a>
                        {% endif %}
                    </div>
                    
                    {% if has_next %}
                        <a href="{{ url_for('list_games', page=page+1, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                           class="pagination-btn">
                            Sonraki <i class="fas fa-chevron-right"></i>
                        </a>
                        <a href="{{ url_for('list_games', page=total_pages, per_page=per_page, q=search_query, category=category_filter, year=year_filter, language=language_filter) }}"
                           class="pagination-btn" title="Son Sayfa">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    {% endif %}
                </div>
                
                <div class="pagination-info">
                    <span style="color: var(--text-secondary);">{{ ((page-1) * per_page + 1) }} - {{ [page * per_page, total_games]|min }} arası,
                          toplam {{ total_pages }} sayfa, {{ total_games }} oyun</span>
                </div>
            </div>
            
            <div class="page-size-selector-bottom" style="display: flex; align-items: center; gap: 12px;">
                <span class="page-size-label" style="color: var(--text-secondary);">Sayfa Boyutu:</span>
                <div class="page-size-boxes">
                    <div class="page-size-box {% if per_page == 8 %}active{% endif %}" onclick="changePageSize(8)">8</div>
                    <div class="page-size-box {% if per_page == 16 %}active{% endif %}" onclick="changePageSize(16)">16</div>
                    <div class="page-size-box {% if per_page == 32 %}active{% endif %}" onclick="changePageSize(32)">32</div>
                    <div class="page-size-box {% if per_page == 48 %}active{% endif %}" onclick="changePageSize(48)">48</div>
                </div>
            </div>
        </div>
    {% endif %}

    {% else %}
    <!-- Boş Durum -->
    <div class="empty-state">
        <i class="fas fa-search"></i>
        <h3 style="color: var(--text-secondary);">Oyun Bulunamadı</h3>
        {% if search_query or category_filter or year_filter or language_filter %}
            <p style="color: var(--text-secondary);">Filtreleme kriterlerinizle eşleşen oyun bulunamadı.</p>
            <button type="button" class="btn btn-secondary" onclick="clearAllFilters()">
                <i class="fas fa-times"></i> Filtreleri Temizle
            </button>
        {% else %}
            <p style="color: var(--text-secondary);">Henüz hiç oyun eklenmemiş.</p>
            <a href="{{ url_for('add_game') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> İlk Oyunu Ekle
            </a>
        {% endif %}
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Modern Dropdown Fonksiyonalitesi
    const modernSelects = document.querySelectorAll('.modern-select');
    
    // Native select'leri gizle
    document.querySelectorAll('.modern-select select').forEach(select => {
        select.style.display = 'none';
    });
    
    modernSelects.forEach(selectContainer => {
        const trigger = selectContainer.querySelector('.modern-select-trigger');
        const options = selectContainer.querySelector('.modern-select-options');
        const optionElements = selectContainer.querySelectorAll('.modern-select-option');
        const textElement = selectContainer.querySelector('.modern-select-text');
        const nativeSelect = selectContainer.querySelector('.modern-select-native');
        
        // Dropdown açma/kapama
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            
            // Diğer açık dropdown'ları kapat
            modernSelects.forEach(otherSelect => {
                if (otherSelect !== selectContainer) {
                    otherSelect.querySelector('.modern-select-trigger').classList.remove('active');
                    otherSelect.querySelector('.modern-select-options').classList.remove('active');
                }
            });
            
            trigger.classList.toggle('active');
            options.classList.toggle('active');
        });
        
        // Seçenek seçimi
        optionElements.forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                
                const value = option.dataset.value;
                const text = option.textContent.trim();
                
                // Seçili durumunu güncelle
                optionElements.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                
                // Görsel metni güncelle
                textElement.textContent = text;
                
                // Native select'i güncelle
                nativeSelect.value = value;
                
                // Dropdown'ı kapat
                trigger.classList.remove('active');
                options.classList.remove('active');
                
                // Form submit
                const form = document.getElementById('filtersForm');
                const pageInput = form.querySelector('input[name="page"]');
                if (pageInput) pageInput.value = 1;
                form.submit();
            });
        });
    });
    
    // Dışarı tıklayınca kapat
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.modern-select')) {
            modernSelects.forEach(selectContainer => {
                const trigger = selectContainer.querySelector('.modern-select-trigger');
                const options = selectContainer.querySelector('.modern-select-options');
                trigger.classList.remove('active');
                options.classList.remove('active');
            });
        }
    });

    // Geleneksel filtre inputları için
    const filterInputs = document.querySelectorAll('.filter-input');
    const form = document.getElementById('filtersForm');
    let filterTimeout;

    filterInputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                // Sayfa numarasını 1'e sıfırla
                const pageInput = form.querySelector('input[name="page"]');
                if (pageInput) pageInput.value = 1;
                
                form.submit();
            }, 500);
        });
    });
});

// Sayfa boyutu değiştirme
function changePageSize(size) {
    const form = document.getElementById('filtersForm');
    const perPageInput = form.querySelector('input[name="per_page"]');
    const pageInput = form.querySelector('input[name="page"]');
    
    if (perPageInput) perPageInput.value = size;
    if (pageInput) pageInput.value = 1; // Sayfa 1'e dön
    
    // Aktif sınıfını güncelle
    document.querySelectorAll('.page-size-box').forEach(box => {
        box.classList.remove('active');
    });
    event.target.classList.add('active');
    
    form.submit();
}

// Tüm filtreleri temizle
function clearAllFilters() {
    const url = new URL(window.location.href);
    url.searchParams.delete('q');
    url.searchParams.delete('category');
    url.searchParams.delete('year');
    url.searchParams.delete('language');
    url.searchParams.set('page', '1');
    
    window.location.href = url.toString();
}

// Oyun durumunu aktif/pasif yapma
function toggleGameStatus(gameId) {
    fetch(`/admin/toggle_game_status/${gameId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Butonu güncelle
            const button = document.querySelector(`button[onclick="toggleGameStatus(${gameId})"]`);
            const icon = button.querySelector('i');
            const card = button.closest('.game-card');
            const badge = card.querySelector('.badge');
            
            if (data.new_status === 1) {
                // Aktif duruma geçti
                button.classList.remove('inactive');
                button.classList.add('active');
                button.title = 'Pasif Yap';
                icon.className = 'fas fa-eye';
                badge.className = 'badge active';
                badge.textContent = 'Aktif';
                // Game card'ı aktif duruma getir (siyah beyaz efektini kaldır)
                card.classList.remove('inactive-game');
            } else {
                // Pasif duruma geçti
                button.classList.remove('active');
                button.classList.add('inactive');
                button.title = 'Aktif Yap';
                icon.className = 'fas fa-eye-slash';
                badge.className = 'badge inactive';
                badge.textContent = 'Pasif';
                // Game card'ı pasif duruma getir (siyah beyaz efekti ekle)
                card.classList.add('inactive-game');
            }
            
            // Başarı mesajı göster (isteğe bağlı)
            console.log(data.message);
        } else {
            alert('Hata: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Bir hata oluştu. Lütfen tekrar deneyin.');
    });
}
</script>
{% endblock %}
