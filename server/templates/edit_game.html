{% extends 'base_admin.html' %}

{% block title %}Oyunu Düzenle{% endblock %}

{% block content %}
<style>
    /* add_game.html'den alınan ve başa taşınan stil tanımları */
    .cover-uploader-container { position: relative; width: 100%; aspect-ratio: 2 / 3; border-radius: var(--border-radius-md); border: 2px dashed var(--color-border); overflow: hidden; background-color: var(--color-background-main); }
    .cover-upload-trigger { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; color: var(--color-text-secondary); cursor: pointer; transition: all 0.2s ease; }
    .cover-upload-trigger:hover { color: var(--color-text-primary); border-color: var(--color-accent-red); background-color: var(--color-surface); }
    .cover-upload-trigger i { font-size: 32px; margin-bottom: 12px; }
    #cover_preview_container { position: relative; width: 100%; height: 100%; }
    #cover_preview_container img { width: 100%; height: 100%; object-fit: cover; }
    .cover-change-overlay { 
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(0,0,0,0.6); 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        color: #fff; 
        cursor: pointer; 
        opacity: 0; 
        transition: opacity 0.3s ease; 
    }
    #cover_preview_container:hover .cover-change-overlay { opacity: 1; }
    .cover-change-overlay i { font-size: 24px; margin-bottom: 8px; }
</style>
<form method="POST" enctype="multipart/form-data" onsubmit="syncEditorContent()">
    <header class="content-header">
        <h2>"{{ game.oyun_adi }}" Düzenle</h2>
    </header>
    
    <div class="tabs">
        <button type="button" class="tab-button active" onclick="openTab(event, 'tab-general')">Genel & Medya</button>
        <button type="button" class="tab-button" onclick="openTab(event, 'tab-technical')">Çalıştırma Ayarları</button>
    </div>

    <div id="tab-general" class="tab-content active">
        <div class="content-body">
            <section class="form-section">
                <h3>Temel Bilgiler</h3>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="oyun_adi">Oyun Adı</label>
                        <input type="text" id="oyun_adi" name="oyun_adi" class="form-control" value="{{ game.oyun_adi }}" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Açıklama</label>
                        <textarea name="aciklama" id="aciklama_textarea" style="display:none;">{{ game.aciklama or '' }}</textarea>
                        <div id="aciklama-editor" class="pell"></div>
                    </div>
                    <div class="form-group full-width">
                        <label>Kategoriler</label>
                        <div class="category-chip-group">
                            {% for category in categories %}
                            <input type="checkbox" name="category_ids" value="{{ category.id }}" id="cat-{{ category.id }}" style="display:none;" {% if category.id in game_category_ids %}checked{% endif %}>
                            <label for="cat-{{ category.id }}" class="category-chip {% if category.id in game_category_ids %}active{% endif %}">{{ category.icon }} {{ category.name }}</label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>Oyun Dilleri</label>
                        <div class="category-chip-group">
                            {% set game_langs = (game.oyun_dili or '').split(',') %}
                            {% for lang in ['Türkçe', 'İngilizce', 'Almanca', 'Fransızca', 'Rusça'] %}
                            <input type="checkbox" name="oyun_dilleri" value="{{ lang }}" id="lang-{{ lang }}" style="display:none;" {% if lang in game_langs %}checked{% endif %}>
                            <label for="lang-{{ lang }}" class="category-chip {% if lang in game_langs %}active{% endif %}">{{ lang }}</label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="youtube_id">YouTube Fragman ID</label>
                        <input type="text" id="youtube_id" name="youtube_id" class="form-control" value="{{ game.youtube_id or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="cikis_yili">Çıkış Yılı</label>
                        <input type="number" id="cikis_yili" name="cikis_yili" class="form-control" value="{{ game.cikis_yili or '' }}" placeholder="Örn: 2025">
                    </div>
                    <div class="form-group">
                        <label for="pegi">PEGI Derecelendirmesi</label>
                        <select id="pegi" name="pegi" class="form-control">
                            <option value="" {% if not game.pegi %}selected{% endif %}>Seçilmedi</option>
                            <option value="3+" {% if game.pegi == '3+' %}selected{% endif %}>3+</option>
                            <option value="7+" {% if game.pegi == '7+' %}selected{% endif %}>7+</option>
                            <option value="12+" {% if game.pegi == '12+' %}selected{% endif %}>12+</option>
                            <option value="16+" {% if game.pegi == '16+' %}selected{% endif %}>16+</option>
                            <option value="18+" {% if game.pegi == '18+' %}selected{% endif %}>18+</option>
                        </select>
                    </div>
                </div>
            </section>
            <section class="form-section">
                <h3>Görsel Yönetimi</h3>
                <div class="visual-management-grid">
                    <div class="upload-card">
                        <label class="upload-label">Kapak Resmi</label>
                        <p class="upload-hint">Değiştirmek için resme tıklayın</p>
                        <div class="cover-uploader-container">
                            <!-- Initial State (hidden if image exists) -->
                            <label for="cover_image" class="cover-upload-trigger" style="display: {% if game.cover_image %}none{% else %}flex{% endif %};">
                                <i class="fa-solid fa-plus"></i>
                                <span>Kapak Ekle</span>
                            </label>
                            <!-- Preview State (visible if image exists) -->
                            <div id="cover_preview_container" style="display: {% if game.cover_image %}block{% else %}none{% endif %};">
                                <img id="cover_image_preview" src="{{ url_for('static', filename='images/covers/' + game.cover_image) if game.cover_image else '#' }}" alt="Kapak Önizleme">
                                <label for="cover_image" class="cover-change-overlay">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                    <span>Değiştir</span>
                                </label>
                            </div>
                        </div>
                        <input type="hidden" name="current_cover_image" value="{{ game.cover_image or '' }}">
                        <input type="file" name="cover_image" id="cover_image" accept="image/*" style="display:none;">
                    </div>
                    <div class="upload-card">
                        <label class="upload-label">Galeri Resimleri</label>
                        <p class="upload-hint">Sürükle-bırak veya seçerek yükleyin</p>
                        <div class="gallery-preview-grid" id="gallery_preview_grid">
                            <label for="gallery_images" class="gallery-upload-trigger"><i class="fa-solid fa-plus"></i><span>Ekle</span></label>
                            {% for img in gallery %}
                            <div class="gallery-item existing-gallery-item">
                                <img src="{{ url_for('static', filename='images/gallery/' + img.image_path) }}" alt="Galeri Resmi">
                                <button type="button" class="delete-gallery-btn" data-path="{{ img.image_path }}"><i class="fa-solid fa-trash"></i></button>
                            </div> 
                            {% endfor %}
                        </div>
                        <input type="file" name="gallery_images[]" id="gallery_images" accept="image/*" multiple style="display:none;">
                    </div>
                </div>
                <div class="form-group full-width" style="margin-top: 20px;">
                    <label for="yuzde_yuz_save_file">%100 Save Dosyası (.zip)</label>
                    {% if game.yuzde_yuz_save_path %}
                        <p class="upload-hint" style="font-size: 13px; margin-bottom: 8px;">Mevcut dosya: <strong>{{ game.yuzde_yuz_save_path }}</strong>. Değiştirmek için yeni bir dosya seçin.</p>
                    {% endif %}
                    <div class="custom-file-input-wrapper">
                        <input type="file" name="yuzde_yuz_save_file" id="yuzde_yuz_save_file_input" class="file-input" accept=".zip">
                        <label for="yuzde_yuz_save_file_input" class="btn btn-secondary"><i class="fa-solid fa-upload"></i> Dosya Seç...</label>
                        <span class="file-name" id="yuzde_yuz_save_file_name">Yeni dosya seçilmedi</span>
                    </div>
                    <!-- Bu gizli alan, backend'deki KeyError'u önlemek için kritik öneme sahiptir -->
                    <input type="hidden" name="current_yuzde_yuz_save_file" value="{{ game.yuzde_yuz_save_path or '' }}">
                </div>
            </section>
        </div>
    </div>
    
    <div id="tab-technical" class="tab-content">
        <div class="content-body">
            <section class="form-section">
                <h3>Çalıştırma Tipi</h3>
                <div class="form-group full-width">
                    <div class="radio-group-horizontal">
                        <input type="radio" id="type_exe" name="calistirma_tipi" value="exe" {% if game.calistirma_tipi == 'exe' %}checked{% endif %}>
                        <label for="type_exe" class="radio-label">
                            <i class="fa-solid fa-file-code"></i>
                            <span>EXE / BAT Dosyası</span>
                        </label>
                        
                        <input type="radio" id="type_steam" name="calistirma_tipi" value="steam" {% if game.calistirma_tipi == 'steam' %}checked{% endif %}>
                        <label for="type_steam" class="radio-label">
                            <i class="fa-brands fa-steam"></i>
                            <span>Steam</span>
                        </label>
                    </div>
                </div>
            </section>
            <section class="form-section">
                <h3>Dinamik Yol (Path) Yönetimi</h3>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="exe_yol">Çalıştırma Dosyası (.EXE) Yolu</label>
                        <div class="input-group">
                            <span class="input-group-text">[GAME_ROOT]\</span>
                            <input type="text" id="exe_yol" name="exe_yol" class="form-control" value="{{ game.calistirma_verisi_dict.get('yol', '') }}" placeholder="OyunAdi\Binaries\Win64\Game.exe">
                        </div>
                        <p class="upload-hint" style="font-size: 12px; margin-top: 8px;">Ana disk yolu <strong>[GAME_ROOT]</strong>, panelin <a href="#">Genel Ayarlar</a> sayfasından yönetilir.</p>
                    </div>
                    <div class="form-group full-width">
                        <label>Sonuç Yolu Önizlemesi</label>
                        <p class="path-preview" id="path-preview">D:\Oyunlar\{{ game.calistirma_verisi_dict.get('yol', '...') }}</p>
                    </div>
                </div>
            </section>
            <section class="form-section">
                <h3>Özel Komut Dosyası (.BAT) Düzenleyici</h3>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Oyun başlamadan önce çalışacak özel komutlar</label>
                        <div class="code-editor-wrapper">
                            <div class="editor-header">custom_script.bat</div>
                            <textarea name="launch_script" class="code-editor-textarea">{{ game.launch_script or '' }}</textarea>
                        </div>
                        <p class="upload-hint" style="font-size: 12px; margin-top: 8px;">
                            Yukarıdaki .exe yolu boş bırakılırsa, bu script doğrudan çalıştırılır.
                            Eğer .exe yolu doluysa, bu script çalıştırılmaz, sadece .exe başlatılır.
                        </p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <footer class="page-actions-footer">
        <div class="status-toggle-group">
            <label for="aktif" class="form-label">Durum</label>
            <label class="toggle-switch">
                <input type="checkbox" id="aktif" name="aktif" {% if game.aktif %}checked{% endif %}>
                <span class="slider"></span>
            </label>
        </div>
        <div class="action-buttons">
            <a href="{{ url_for('list_games') }}" class="btn btn-secondary">İptal</a>
            <button type="submit" class="btn btn-primary"><i class="fa-solid fa-save"></i> Değişiklikleri Kaydet</button>
        </div>
    </footer>
</form>

<!-- Gerekli Kütüphaneler -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/pell.css') }}">
<script src="{{ url_for('static', filename='js/pell.min.js') }}"></script>

<script>
    // Chip'lerin seçili durumunu yönetmek için
    document.querySelectorAll('.category-chip-group .category-chip').forEach(chip => {
        chip.addEventListener('click', function(e) {
            e.preventDefault();
            const checkboxId = this.getAttribute('for');
            const checkbox = document.getElementById(checkboxId);
            checkbox.checked = !checkbox.checked;
            this.classList.toggle('active', checkbox.checked);
        });
    });

    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    let aciklamaEditor;
    function syncEditorContent() {
        const descriptionTextarea = document.getElementById('aciklama_textarea');
        if (aciklamaEditor && descriptionTextarea) {
            descriptionTextarea.value = aciklamaEditor.content.innerHTML;
        }
        return true; // Formun gönderilmesine izin ver
    }

    document.addEventListener('DOMContentLoaded', () => {
        try {
            // Pell editörünü başlat
            aciklamaEditor = window.pell.init({
                element: document.getElementById('aciklama-editor'),
                defaultParagraphSeparator: 'p',
                styleWithCSS: false,
                actions: ['bold', 'italic', 'underline', 'strikethrough', 'olist', 'ulist', 'link'],
                onChange: html => {
                    document.getElementById('aciklama_textarea').value = html;
                }
            });
            // Mevcut içeriği editöre yükle
            const initialContent = document.getElementById('aciklama_textarea').value;
            if (aciklamaEditor && initialContent) {
                aciklamaEditor.content.innerHTML = initialContent;
            }
        } catch (e) {
            console.error("Pell editor başlatılamadı:", e);
        }

        try {
            // Path preview
            const exePathInput = document.getElementById('exe_yol');
            const pathPreview = document.getElementById('path-preview');
            if (exePathInput && pathPreview) {
                exePathInput.addEventListener('input', function() {
                    pathPreview.textContent = `D:\\Oyunlar\\${this.value.replace(/\\/g, '\\')}`;
                });
            }
        } catch (e) {
            console.error("Path preview hatası:", e);
        }

        try {
            // Kapak resmi önizleme
            const coverInput = document.getElementById('cover_image');
            const coverUploadTrigger = document.querySelector('.cover-upload-trigger');
            const coverPreviewContainer = document.getElementById('cover_preview_container');
            const coverPreview = document.getElementById('cover_image_preview');

            if (coverInput && coverPreview) {
                coverInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        coverPreview.src = URL.createObjectURL(file);
                        coverPreview.onload = () => URL.revokeObjectURL(coverPreview.src);

                        if (coverUploadTrigger) coverUploadTrigger.style.display = 'none';
                        if (coverPreviewContainer) coverPreviewContainer.style.display = 'block';
                    }
                });
            }
        } catch (e) {
            console.error("Kapak resmi önizleme hatası:", e);
        }

        try {
            // Galeri resimleri yönetimi
            const galleryInput = document.getElementById('gallery_images');
            const galleryGrid = document.getElementById('gallery_preview_grid');
            const uploadTrigger = galleryGrid.querySelector('.gallery-upload-trigger');
            const form = galleryGrid.closest('form');
            const fileStore = new DataTransfer(); // Yeni dosyaları tutmak için

            // Silinecek mevcut resimlerin yollarını tutacak gizli bir alan
            let deletedImagesInput = form.querySelector('input[name="delete_gallery_paths"]');
            if (!deletedImagesInput) {
                deletedImagesInput = document.createElement('input');
                deletedImagesInput.type = 'hidden';
                deletedImagesInput.name = 'delete_gallery_paths';
                form.appendChild(deletedImagesInput);
            }
            let deletedImagePaths = [];

            const updateGalleryInput = () => {
                galleryInput.files = fileStore.files;
            };

            const createGalleryPreviewItem = (file) => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item new-gallery-item';

                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = () => URL.revokeObjectURL(img.src);
                galleryItem.appendChild(img);

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'delete-gallery-btn';
                deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                deleteBtn.onclick = () => {
                    const newFiles = new DataTransfer();
                    Array.from(fileStore.files).forEach(f => {
                        if (f !== file) newFiles.items.add(f);
                    });
                    fileStore.clearData();
                    Array.from(newFiles.files).forEach(f => fileStore.items.add(f));
                    
                    updateGalleryInput();
                    galleryItem.remove();
                };
                galleryItem.appendChild(deleteBtn);

                galleryGrid.insertBefore(galleryItem, uploadTrigger);
            };

            galleryInput.addEventListener('change', (event) => {
                const existingFileNames = new Set(Array.from(fileStore.files).map(f => f.name));
                Array.from(event.target.files).forEach(file => {
                    if (!existingFileNames.has(file.name)) {
                        fileStore.items.add(file);
                        createGalleryPreviewItem(file);
                    }
                });
                updateGalleryInput();
                event.target.value = '';
            });

            document.querySelectorAll('.existing-gallery-item .delete-gallery-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const imagePath = this.dataset.path;
                    const parentItem = this.closest('.existing-gallery-item');
                    if (imagePath && !deletedImagePaths.includes(imagePath)) {
                        deletedImagePaths.push(imagePath);
                        deletedImagesInput.value = JSON.stringify(deletedImagePaths);
                        if (parentItem) {
                            parentItem.style.transition = 'opacity 0.3s ease';
                            parentItem.style.opacity = '0';
                            setTimeout(() => parentItem.remove(), 300);
                        }
                    }
                });
            });
        } catch (e) {
            console.error("Galeri yönetimi hatası:", e);
        }

        try {
            // %100 save dosyası için etiket güncellemesi
            const saveFileInput = document.getElementById('yuzde_yuz_save_file_input');
            const saveFileName = document.getElementById('yuzde_yuz_save_file_name');
            if(saveFileInput && saveFileName) {
                saveFileInput.addEventListener('change', (event) => {
                    saveFileName.textContent = event.target.files.length > 0 ? event.target.files[0].name : 'Yeni dosya seçilmedi';
                });
            }
        } catch (e) {
            console.error("Save dosyası etiket güncelleme hatası:", e);
        }
    }); 
</script>
{% endblock %}