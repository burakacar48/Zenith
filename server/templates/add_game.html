{% extends 'base_admin.html' %}

{% block title %}Yeni Oyun Ekle{% endblock %}

{% block head %}
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/pell/dist/pell.min.css">
{% endblock %}

{% block content %}
    <header class="header">
        <h1>Yeni Oyun Ekle</h1>
        <div class="header-actions">
            <a href="{{ url_for('list_games') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Geri Dön
            </a>
        </div>
    </header>

    <div class="card full-width">
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                <div class="tab-container">
                    <div class="tab-nav">
                        <div class="tab-nav-item active" data-tab="temel-bilgiler">Temel Bilgiler</div>
                        <div class="tab-nav-item" data-tab="gorsel-yonetim">Görsel Yönetimi</div>
                        <div class="tab-nav-item" data-tab="calistirma-ayarlari">Çalıştırma Ayarları</div>
                    </div>

                    <div id="temel-bilgiler" class="tab-content active">
                        <h2 class="form-section-title">Temel Bilgiler</h2>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="oyun_adi_input">Oyun Adı:</label>
                                <input type="text" name="oyun_adi" id="oyun_adi_input" required>
                            </div>
                            
                            <div class="form-group full-width">
                                <label>Kategoriler:</label>
                                <div class="category-checkbox-container">
                                    {% for category in categories %}
                                        <label class="category-checkbox-label">
                                            <input type="checkbox" name="category_ids" value="{{ category.id }}">
                                            <span class="category-checkbox-custom">
                                                <i class="fas fa-check"></i>
                                                {{ category.icon }} {{ category.name }}
                                            </span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="youtube_id_input">YouTube Fragman ID:</label>
                                <input type="text" name="youtube_id" id="youtube_id_input" placeholder="video_id">
                            </div>
                            <div class="form-group">
                                <label for="cikis_yili_input">Çıkış Yılı:</label>
                                <input type="text" name="cikis_yili" id="cikis_yili_input" placeholder="2023">
                            </div>
                            <div class="form-group">
                                <label for="pegi_input">PEGI Rating:</label>
                                <input type="text" name="pegi" id="pegi_input" placeholder="PEGI 18">
                            </div>
                            
                            <div class="form-group">
                                <label for="oyun_dili_select">Oyun Dili:</label>
                                <select name="oyun_dili" id="oyun_dili_select">
                                    <option value="Türkçe Dublaj">Türkçe Dublaj</option>
                                    <option value="Türkçe Altyazı">Türkçe Altyazı</option>
                                    <option value="İngilizce" selected>İngilizce</option>
                                </select>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="aciklama_textarea">Açıklama:</label>
                                <textarea name="aciklama" id="aciklama_textarea" rows="4" style="display:none;"></textarea>
                                <div id="aciklama-editor" class="pell"></div>
                            </div>
                        </div>
                    </div>

                    <div id="gorsel-yonetim" class="tab-content">
                        <div class="media-grid">
                            <div id="cover-slot" class="grid-item cover-image-slot">
                                <div class="cover-label">✨ Kapak Resmi</div>
                                <label for="cover-input" class="cover-uploader">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></svg>
                                    <span>Kapak Resmi Yükle</span>
                                </label>
                                <img id="cover-image" src="" alt="Kapak Resmi">
                                <label for="cover-input" id="change-cover-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" /><path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" /><path d="M16 5l3 3" /></svg>
                                    Değiştir
                                </label>
                            </div>
                            <input type="file" name="cover_image" id="cover-input" class="hidden-input" accept="image/*">

                            <label for="gallery-input" class="grid-item add-gallery-slot">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>Resim Ekle</span>
                            </label>
                            <input type="file" name="gallery_images" id="gallery-input" class="hidden-input" accept="image/*" multiple>
                        </div>
                    </div>

                    <div id="calistirma-ayarlari" class="tab-content">
                        <h2 class="form-section-title">Teknik Bilgiler</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="save_yolu_input">Save Dosyası Yolu:</label>
                                <input type="text" name="save_yolu" id="save_yolu_input" placeholder="%USERPROFILE%\Documents\My Games\...">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="calistirma_tipi">Çalıştırma Tipi:</label>
                                <select name="calistirma_tipi" id="calistirma_tipi" onchange="updateCalistirmaInputs()">
                                    <option value="exe" selected>EXE</option>
                                    <option value="steam">Steam</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex-grow: 1.5;"> <div id="exe_fields" class="calistirma-field-group">
                                    <label for="exe_yol_input_file">EXE Yolu:</label>
                                    <input type="hidden" name="exe_yol" id="exe_yol_input" value="">
                                    <div class="custom-file-path-wrapper">
                                        <input type="file" name="exe_yol_file" id="exe_yol_input_file" class="file-input" accept=".exe">
                                        <label for="exe_yol_input_file" class="file-path-display" id="exe_yol_display">
                                            <span class="file-path-placeholder">Dosya seçmek için tıklayın...</span>
                                        </label>
                                    </div>
                                </div>
                                <div id="steam_fields" class="hidden calistirma-field-group">
                                    <label for="steam_app_id_input">Steam App ID:</label>
                                    <input type="text" name="steam_app_id" id="steam_app_id_input" placeholder="Örn: 730">
                                </div>
                            </div>
                        </div>
                        <div id="exe_extra_fields">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="exe_argumanlar_input">Argümanlar (isteğe bağlı):</label>
                                    <input type="text" name="exe_argumanlar" id="exe_argumanlar_input" placeholder="-fullscreen -novid">
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-save"></i>
                    Yeni Oyunu Ekle
                </button>
            </form>
        </div>
    </div>


{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/pell"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Tab functionality
            const tabNavItems = document.querySelectorAll('.tab-nav-item');
            const tabContents = document.querySelectorAll('.tab-content');
            tabNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = item.getAttribute('data-tab');
                    tabNavItems.forEach(navItem => navItem.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    item.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // Pell editor
            var editorEl = document.getElementById('aciklama-editor');
            if (editorEl) {
              const editorInstance = pell.init({
                element: editorEl,
                onChange: html => { document.getElementById('aciklama_textarea').value = html; },
                defaultParagraphSeparator: 'p',
                styleWithCSS: false,
                actions: ['bold', 'italic', 'underline', 'strikethrough', 'olist', 'ulist', 'link']
              });
              editorInstance.content.innerHTML = document.getElementById('aciklama_textarea').value;
            }

            // New Media Manager JS
            const coverInput = document.getElementById('cover-input');
            const coverSlot = document.getElementById('cover-slot');
            const coverImage = document.getElementById('cover-image');

            coverInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        coverImage.src = e.target.result;
                        coverSlot.classList.add('has-image');
                    }
                    reader.readAsDataURL(file);
                }
            });

            const galleryInput = document.getElementById('gallery-input');
            const mediaGrid = document.querySelector('.media-grid');

            galleryInput.addEventListener('change', (e) => {
                const files = e.target.files;
                for(let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const newGalleryItem = document.createElement('div');
                        newGalleryItem.className = 'grid-item gallery-item';
                        newGalleryItem.dataset.id = 'new-' + i;
                        newGalleryItem.innerHTML = `
                            <div class="selection-tick"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/></svg></div>
                            <img src="${e.target.result}" alt="Yeni Galeri Resmi">
                            <input type="checkbox" name="new_gallery_images" value="${file.name}" class="hidden-input">
                        `;
                        mediaGrid.insertBefore(newGalleryItem, mediaGrid.querySelector('.add-gallery-slot'));
                    }
                    reader.readAsDataURL(file);
                }
            });
        });
    </script>
{% endblock %}