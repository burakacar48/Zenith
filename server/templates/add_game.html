
{% extends 'base_admin.html' %}

{% block title %}Yeni Oyun Ekle{% endblock %}

{% block head %}
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/pell/dist/pell.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1 class="page-title">Yeni Oyun Ekle</h1>
        <p class="page-description">Yeni oyun ekleyin ve bilgilerini girin</p>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <!-- Tab Navigation -->
        <div class="section">
            <div class="tabs">
                <button type="button" class="tab-btn active" onclick="switchTab('temel')">
                    <i class="fas fa-info-circle"></i>
                    Temel Bilgiler
                </button>
                <button type="button" class="tab-btn" onclick="switchTab('gorsel')">
                    <i class="fas fa-images"></i>
                    Görsel Yönetimi
                </button>
                <button type="button" class="tab-btn" onclick="switchTab('calistirma')">
                    <i class="fas fa-cog"></i>
                    Çalıştırma Ayarları
                </button>
            </div>
        </div>

        <!-- Temel Bilgiler Tab -->
        <div id="temel-tab" class="tab-content active">
            <div class="card" style="padding: 2rem;">
                <div class="form-grid">
                    <!-- Oyun Adı - Full Width -->
                    <div class="form-group full-width">
                        <label class="form-label">
                            <i class="fas fa-gamepad"></i>
                            <span>Oyun Adı</span>
                        </label>
                        <input type="text" name="oyun_adi" value="" required class="form-input">
                    </div>
                    
                    <!-- YouTube & PEGI - Side by Side -->
                    <!-- YouTube Fragman ID - Full Width -->
                    <div class="form-group full-width">
                        <label class="form-label">
                            <i class="fab fa-youtube"></i>
                            <span>YouTube Fragman ID</span>
                        </label>
                        <input type="text" name="youtube_id" id="youtube_id" value="" placeholder="gmA6MrX81z4" class="form-input">
                        <div class="input-hint">
                            <span style="font-style: italic; opacity: 0.8;">https://www.youtube.com/watch?v=</span><strong style="color: #64748b;">gmA6MrX81z4</strong>
                            <span style="margin-left: 0.5rem; opacity: 0.7;">— YouTube linkini veya video ID'sini yapıştırabilirsiniz</span>
                        </div>
                    </div>

                    <!-- Çıkış Yılı & PEGI Rating - Side by Side -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Çıkış Yılı</span>
                        </label>
                        <input type="text" name="cikis_yili" value="" placeholder="2023" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-shield-alt"></i>
                            <span>PEGI Rating</span>
                        </label>
                        <input type="text" name="pegi" value="" placeholder="PEGI 18" class="form-input">
                    </div>
                    
                    <!-- Kategoriler - Full Width -->
                    <div class="form-group full-width">
                        <label class="form-label">
                            <i class="fas fa-tags"></i>
                            <span>Kategoriler</span>
                        </label>
                        <div class="badge-grid">
                            {% for category in categories %}
                                <label style="cursor: pointer;">
                                    <input type="checkbox" name="category_ids" value="{{ category.id }}" style="display: none;">
                                    <span class="category-badge">{{ category.icon }} {{ category.name }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Oyun Dili - Full Width -->
                    <div class="form-group full-width">
                        <label class="form-label">
                            <i class="fas fa-language"></i>
                            <span>Oyun Dili</span>
                        </label>
                        <div class="badge-grid">
                            {% for language in languages %}
                                <label style="cursor: pointer;" class="language-option">
                                    <input type="checkbox" name="language_ids" value="{{ language.name }}" style="display: none;">
                                    <span class="category-badge language-badge">{{ language.name }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Açıklama - Full Width -->
                    <div class="form-group full-width">
                        <label class="form-label">
                            <i class="fas fa-align-left"></i>
                            <span>Açıklama</span>
                        </label>
                        <textarea name="aciklama" id="aciklama_textarea" rows="4" style="display:none;"></textarea>
                        <div id="aciklama-editor"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Görsel Yönetimi Tab -->
        <div id="gorsel-tab" class="tab-content">
            <div class="card" style="padding: 1.5rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">
                    <i class="fas fa-image" style="margin-right: 0.5rem; color: #64748b;"></i>
                    Kapak Görseli
                </h3>
                
                <div class="upload-zone" id="cover-upload-zone" onclick="triggerFileInput('cover_image')">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h4>Kapak Görseli Yükle</h4>
                    <p>2:3 oranında görsel yükleyin (örn: 600x900px)</p>
                    <button type="button" class="btn btn-secondary">Dosya Seç</button>
                </div>
                
                <div class="cover-images-grid" style="display: none;"></div>
                
                <input type="file" id="cover_image" name="cover_image" accept="image/*" style="display: none;" onchange="handleCoverImageSelect(this)">
                
                <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border);">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin: 0;">
                        <i class="fas fa-images" style="margin-right: 0.5rem; color: #64748b;"></i>
                        Galeri Görselleri
                    </h3>
                    <div id="delete-warning" class="delete-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="delete-count">0</span> adet görsel silinmek üzere işaretlenmiştir
                    </div>
                </div>
                
                <div class="upload-zone" id="gallery-upload-zone" onclick="triggerFileInput('gallery_images')">
                    <div class="upload-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    <h4>Galeri Görselleri Yükle</h4>
                    <p>16:9 oranında birden fazla görsel yükleyin (örn: 1920x1080px)</p>
                    <button type="button" class="btn btn-secondary">Görselleri Seç</button>
                </div>
                
                <input type="file" id="gallery_images" name="gallery_images" accept="image/*" multiple style="display: none;" onchange="handleGalleryImagesSelect(this)">
                
                <div class="images-grid" id="gallery-images-grid"></div>
            </div>
        </div>

        <!-- Çalıştırma Ayarları Tab -->
        <div id="calistirma-tab" class="tab-content">
            <div class="card" style="padding: 1.5rem;">
                <div>
                    <label class="form-label">
                        <i class="fas fa-play-circle"></i>
                        <span>Çalıştırma Tipi</span>
                    </label>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem; max-width: 400px;">
                        <button type="button" id="exe-btn" class="execution-btn" onclick="selectExecutionType('exe')">
                            <i class="fas fa-desktop"></i>
                            <span>EXE</span>
                        </button>
                        <button type="button" id="steam-btn" class="execution-btn execution-btn-steam" onclick="selectExecutionType('steam')">
                            <i class="fab fa-steam"></i>
                            <span>Steam</span>
                        </button>
                    </div>
                    <input type="hidden" name="calistirma_tipi" id="calistirma_tipi" value="exe">
                </div>
                
                <div id="exe-section" style="margin-top: 1.5rem;">
                    <div class="form-grid" style="gap: 1.5rem;">
                        <!-- Disk Seçimi -->
                        <div class="form-group full-width">
                            <label class="form-label">
                                <i class="fas fa-hdd"></i>
                                <span>Mevcut Diskler</span>
                            </label>
                            {% if drives %}
                                <div class="disk-selection-grid">
                                    {% for drive in drives %}
                                    <div class="disk-card" onclick="selectDisk('{{ drive.device_id }}')" data-disk="{{ drive.device_id }}">
                                        <div class="disk-icon">
                                            <i class="fas fa-hard-drive"></i>
                                        </div>
                                        <div class="disk-info">
                                            <div class="disk-name">
                                                {% if drive.custom_name %}
                                                    {{ drive.custom_name }}
                                                {% else %}
                                                    {{ drive.volume_name }}
                                                {% endif %}
                                            </div>
                                            <div class="disk-letter">{{ drive.device_id }}</div>
                                            {% if drive.free_space_gb != 'Bilinmiyor' %}
                                            <div class="disk-space">
                                                <span class="free-space">{{ drive.free_space_gb }} GB Boş</span>
                                                <div class="space-bar">
                                                    <div class="space-used" style="width: {{ drive.usage_percent }}%"></div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="no-disks">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>Mevcut disk bulunamadı. Disk Ayarları sayfasından diskleri kontrol edin.</span>
                                </div>
                            {% endif %}
                        </div>

                        <!-- EXE Dosya Yolu -->
                        <div class="form-group full-width">
                            <label class="form-label">
                                <i class="fas fa-file-code"></i>
                                <span>EXE Dosya Yolu</span>
                            </label>
                            <input type="text" name="exe_path" value="" placeholder="EXE dosya yolunu girin..." class="form-input">
                        </div>

                        <!-- Oyun Kayıt Yolu -->
                        <div class="form-group full-width">
                            <label class="form-label">
                                <i class="fas fa-save"></i>
                                <span>Oyun Kayıt Yolu</span>
                            </label>
                            <input type="text" name="save_path" value="" placeholder="Örn: C:\Users\%USERNAME%\AppData\Local\GameName\Saved" class="form-input">
                        </div>

                        <!-- %100 Save Dosyası -->
                        <div class="form-group full-width">
                            <label class="form-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>%100 Save Dosyası</span>
                            </label>
                            <div class="save-upload-zone" onclick="triggerFileInput('save_file')">
                                <div class="upload-icon" style="font-size: 2rem; margin-bottom: 0.5rem;">
                                    <i class="fas fa-file-archive"></i>
                                </div>
                                <p style="margin: 0; font-size: 0.875rem; color: var(--muted-foreground);">
                                    Save dosyasını yüklemek için tıklayın
                                </p>
                            </div>
                            <input type="file" id="save_file" name="save_file" accept=".zip,.rar,.7z" style="display: none;" onchange="handleSaveFileSelect(this)">
                        </div>

                        <!-- Özel Başlatma (.bat) -->
                        <div class="form-group full-width">
                            <label class="checkbox-label">
                                <input type="checkbox" id="custom_startup" name="custom_startup" onchange="toggleCustomStartup(this.checked)">
                                <span class="checkbox-text">
                                    <i class="fas fa-terminal"></i>
                                    Özel Başlatma Gerekiyor (.bat)
                                </span>
                            </label>
                        </div>

                        <!-- BAT Script Editor -->
                        


                        <div id="bat-script-section" style="display: none;" class="form-group full-width">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <label class="form-label" style="margin: 0;">
                                    <i class="fas fa-file-code"></i>
                                    <span>Başlatma Script'i</span>
                                </label>
                                <button type="button" class="btn btn-secondary" onclick="openBatEditor()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    <i class="fas fa-edit"></i>
                                    Script Editörü
                                </button>
                            </div>
                            <textarea id="bat_script" name="bat_script" rows="8" style="display: none;">@echo off
REM Auto-generated startup script for new game
REM Game: New Game
REM EXE Path: %EXE_PATH%

echo Starting new game...
start "" "%EXE_PATH%"
</textarea>
                            <div id="bat-script-editor" style="border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; overflow: hidden;"></div>
                        </div>
                    </div>
                </div>
                
                <div id="steam-section" style="margin-top: 1.5rem; display: none;">
                    <label class="form-label">
                        <i class="fab fa-steam-symbol"></i>
                        <span>Steam Game ID</span>
                    </label>
                    <input type="text" name="steam_app_id" value="" placeholder="Örn: 271590 (GTA V), 730 (CS:GO)" class="form-input">
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
            <a href="{{ url_for('list_games') }}" style="padding: 0.75rem 1.5rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; color: var(--foreground); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-arrow-left"></i> Geri Dön
            </a>
            <button type="submit" style="padding: 0.75rem 1.5rem; background: #64748b; border: none; border-radius: 0.5rem; color: white; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                <i class="fas fa-save"></i> Yeni Oyunu Ekle
            </button>
        </div>

        <input type="hidden" name="delete_gallery_images" id="delete_gallery_images" value="">
    </form>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/pell"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/shell/shell.min.js"></script>
    <script>
        // Global CodeMirror instances
        let batCodeMirror = null;
        let batScriptEditor = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            // Check URL hash and restore tab state
            const hash = window.location.hash.substring(1); // Remove # character
            const validTabs = ['temel', 'gorsel', 'calistirma'];
            
            if (hash && validTabs.includes(hash)) {
                // Manually activate the correct tab on page load
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                
                document.getElementById(hash + '-tab').classList.add('active');
                
                // Find and activate the correct button
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    const btnText = btn.textContent.toLowerCase();
                    if ((hash === 'temel' && btnText.includes('temel')) ||
                        (hash === 'gorsel' && btnText.includes('görsel')) ||
                        (hash === 'calistirma' && btnText.includes('çalıştırma'))) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Pell editor
            const editor = pell.init({
                element: document.getElementById('aciklama-editor'),
                onChange: html => {
                    document.getElementById('aciklama_textarea').value = html;
                },
                defaultParagraphSeparator: 'p',
                styleWithCSS: false,
                actions: ['bold', 'italic', 'underline', 'strikethrough', 'olist', 'ulist', 'link']
            });
            editor.content.innerHTML = document.getElementById('aciklama_textarea').value;

            // Initialize execution type
            const currentType = 'exe';
            selectExecutionType(currentType);

            // Initialize BAT Script CodeMirror Editor
            const batScriptTextarea = document.getElementById('bat_script');
            if (batScriptTextarea) {
                batScriptEditor = CodeMirror(document.getElementById('bat-script-editor'), {
                    value: batScriptTextarea.value,
                    mode: 'shell',
                    theme: 'monokai',
                    lineNumbers: true,
                    lineWrapping: true,
                    indentUnit: 4,
                    tabSize: 4,
                    indentWithTabs: false,
                    styleActiveLine: true,
                    matchBrackets: true,
                    autoCloseBrackets: true,
                    placeholder: 'Başlatma scriptinizi buraya yazın...'
                });
                
                // Set editor height
                batScriptEditor.setSize(null, '300px');
                
                // Sync with textarea
                batScriptEditor.on('change', function() {
                    batScriptTextarea.value = batScriptEditor.getValue();
                });
            }

            // YouTube ID auto-detection
            const youtubeInput = document.getElementById('youtube_id');
            if (youtubeInput) {
                youtubeInput.addEventListener('input', function() {
                    const value = this.value.trim();
                    
                    // Check if it's a YouTube URL and extract the video ID
                    const youtubePatterns = [
                        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
                        /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/,
                        /youtu\.be\/([a-zA-Z0-9_-]{11})/,
                        /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/
                    ];
                    
                    for (const pattern of youtubePatterns) {
                        const match = value.match(pattern);
                        if (match) {
                            this.value = match[1]; // Extract and set only the video ID
                            break;
                        }
                    }
                });
            }

            // Category badge styling
            document.querySelectorAll('.category-badge:not(.language-badge)').forEach(badge => {
                const input = badge.previousElementSibling;
                const updateStyle = () => {
                    if (input.checked) {
                        badge.style.background = '#64748b';
                        badge.style.color = 'white';
                        badge.style.borderColor = '#64748b';
                    } else {
                        badge.style.background = 'rgba(255, 255, 255, 0.05)';
                        badge.style.color = '';
                        badge.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                    }
                };
                input.addEventListener('change', updateStyle);
                updateStyle();
            });

            // Language badge styling - now with multiple selection support
            document.querySelectorAll('.language-badge').forEach(badge => {
                const input = badge.previousElementSibling;
                
                const updateStyle = () => {
                    if (input.checked) {
                        badge.style.background = '#64748b';
                        badge.style.color = 'white';
                        badge.style.borderColor = '#64748b';
                    } else {
                        badge.style.background = 'rgba(255, 255, 255, 0.05)';
                        badge.style.color = '';
                        badge.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                    }
                };
                
                input.addEventListener('change', updateStyle);
                updateStyle();
            });
        });

        // Tab switching
        window.switchTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // If called programmatically, find and activate the button
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(tabName)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Save current tab to URL hash
            window.location.hash = tabName;
        };

        // Execution type selection
        window.selectExecutionType = function(type) {
            const exeBtn = document.getElementById('exe-btn');
            const steamBtn = document.getElementById('steam-btn');
            const exeSection = document.getElementById('exe-section');
            const steamSection = document.getElementById('steam-section');
            
            if (type === 'exe') {
                exeBtn.classList.add('active');
                steamBtn.classList.remove('active');
                exeSection.style.display = 'block';
                steamSection.style.display = 'none';
            } else {
                steamBtn.classList.add('active');
                exeBtn.classList.remove('active');
                steamSection.style.display = 'block';
                exeSection.style.display = 'none';
            }
            
            document.getElementById('calistirma_tipi').value = type;
        };

        // Cover image functions
        window.triggerFileInput = function(inputId) {
            document.getElementById(inputId).click();
        };

        window.handleCoverImageSelect = function(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Hide upload zone
                    document.getElementById('cover-upload-zone').classList.add('upload-hidden');
                    
                    // Create or update preview
                    let previewContainer = document.querySelector('.cover-images-grid');
                    if (!previewContainer) {
                        previewContainer = document.createElement('div');
                        previewContainer.className = 'cover-images-grid';
                        document.getElementById('cover-upload-zone').parentNode.insertBefore(
                            previewContainer,
                            document.getElementById('cover-upload-zone').nextSibling
                        );
                    }
                    
                    previewContainer.innerHTML = `
                        <div class="cover-image-card">
                            <div class="cover-image-wrapper">
                                <img src="${e.target.result}" alt="Yeni Kapak Görseli">
                                <div class="image-overlay">
                                    <div class="image-actions">
                                        <button type="button" class="action-btn" onclick="changeCoverImage()">Değiştir</button>
                                        <button type="button" class="action-btn delete" onclick="removeCoverImage()">Kaldır</button>
                                    </div>
                                </div>
                            </div>
                            <div class="image-info">
                                <div class="image-name">${file.name}</div>
                                <div class="image-details">
                                    <span>Yeni Kapak</span>
                                    <span>Seçildi</span>
                                </div>
                            </div>
                        </div>
                    `;
                    previewContainer.style.display = 'flex';
                };
                
                reader.readAsDataURL(file);
            }
        };

        window.changeCoverImage = function() {
            document.getElementById('cover_image').click();
        };

        window.removeCoverImage = function() {
            if (confirm('Kapak görselini kaldırmak istediğinizden emin misiniz?')) {
                // Hide current cover image
                document.querySelector('.cover-images-grid').style.display = 'none';
                // Show upload zone
                document.getElementById('cover-upload-zone').classList.remove('upload-hidden');
            }
        };

        // Gallery image functions
        window.handleGalleryImagesSelect = function(input) {
            if (input.files && input.files.length > 0) {
                let galleryGrid = document.getElementById('gallery-images-grid');
                
                // Create gallery grid if it doesn't exist
                if (!galleryGrid) {
                    galleryGrid = document.createElement('div');
                    galleryGrid.id = 'gallery-images-grid';
                    galleryGrid.className = 'images-grid';
                    document.getElementById('gallery-upload-zone').parentNode.appendChild(galleryGrid);
                }
                
                // Process each selected file
                Array.from(input.files).forEach((file, index) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imageCard = document.createElement('div');
                        imageCard.className = 'image-card';
                        imageCard.setAttribute('data-image', file.name);
                        
                        imageCard.innerHTML = `
                            <div class="selection-indicator">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="image-wrapper">
                                <img src="${e.target.result}" alt="Galeri ${index + 1}">
                            </div>
                            <div class="image-info">
                                <div class="image-name">${file.name}</div>
                                <div class="image-details">
                                    <span>Yeni Galeri</span>
                                    <button type="button" class="action-btn delete" onclick="removeGalleryImage('${file.name}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                


                        galleryGrid.appendChild(imageCard);
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
        };

        window.removeGalleryImage = function(imageName) {
            if (confirm('Bu galeri görselini kaldırmak istediğinizden emin misiniz?\n' + imageName)) {
                const imageCard = document.querySelector(`.image-card[data-image="${imageName}"]`);
                if (imageCard) {
                    imageCard.remove();
                    
                    // Check if there are any remaining images
                    const remainingImages = document.querySelectorAll('.image-card');
                    if (remainingImages.length === 0) {
                        const galleryGrid = document.getElementById('gallery-images-grid');
                        if (galleryGrid) {
                            galleryGrid.remove();
                        }
                    }
                }
            }
        };

        // Gallery image selection for deletion
        window.toggleImageSelection = function(imageName) {
            const imageCard = document.querySelector(`.image-card[data-image="${imageName}"]`);
            if (!imageCard) return;
            
            imageCard.classList.toggle('selected');
            updateDeleteCounter();
        };

        function updateDeleteCounter() {
            const selectedImages = document.querySelectorAll('.image-card.selected');
            const deleteWarning = document.getElementById('delete-warning');
            const deleteCount = document.getElementById('delete-count');
            
            if (selectedImages.length > 0) {
                deleteCount.textContent = selectedImages.length;
                deleteWarning.style.display = 'block';
            } else {
                deleteWarning.style.display = 'none';
            }
        }

        // Add click handlers to existing gallery images
        document.addEventListener('DOMContentLoaded', () => {
            // Function to add click handler to image cards
            function addClickHandler(card) {
                const imageName = card.getAttribute('data-image');
                card.addEventListener('click', (e) => {
                    // Don't toggle if clicking the delete button
                    if (e.target.closest('.action-btn')) return;
                    toggleImageSelection(imageName);
                });
            }
            
            // Add click handlers to existing image cards
            document.querySelectorAll('.image-card').forEach(addClickHandler);
            
            // Watch for dynamically added image cards
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // Check if the added node is an image card
                            if (node.classList && node.classList.contains('image-card')) {
                                addClickHandler(node);
                            }
                            // Check if the added node contains image cards
                            const imageCards = node.querySelectorAll && node.querySelectorAll('.image-card');
                            if (imageCards) {
                                imageCards.forEach(addClickHandler);
                            }
                        }
                    });
                });
            });
            
            // Start observing the gallery grid for changes
            const galleryGrid = document.getElementById('gallery-images-grid');
            if (galleryGrid) {
                observer.observe(galleryGrid, { childList: true });
            }
            
            // Add form submit handler to populate delete_gallery_images field
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const selectedImages = document.querySelectorAll('.image-card.selected');
                    const imageNames = Array.from(selectedImages).map(card => {
                        return card.getAttribute('data-image');
                    });
                    
                    // Debug log
                    console.log('Selected images for deletion:', imageNames);
                    
                    const deleteField = document.getElementById('delete_gallery_images');
                    deleteField.value = imageNames.join(',');
                    
                    // Debug log
                    console.log('Delete field value:', deleteField.value);
                });
            }
        });

        // Save file handling
        window.handleSaveFileSelect = function(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const saveZone = document.querySelector('.save-upload-zone p');
                saveZone.innerHTML = `<strong style="color: #64748b;">${file.name}</strong>`;
            }
        };

        // Custom startup toggle
        window.toggleCustomStartup = function(isChecked) {
            const batSection = document.getElementById('bat-script-section');
            if (isChecked) {
                batSection.style.display = 'block';
                // Generate default script if empty
                const scriptTextarea = document.getElementById('bat_script');
                if (!scriptTextarea.value.trim()) {
                    const gameName = document.querySelector('input[name="oyun_adi"]').value || 'Game';
                    scriptTextarea.value = `@echo off
REM Auto-generated startup script for ${gameName}
REM Game: ${gameName}
REM EXE Path: %EXE_PATH%

echo Starting ${gameName}...
start "" "%EXE_PATH%"
`;
                }
            } else {
                batSection.style.display = 'none';
            }
        };

        // BAT Script Editor Modal
        window.openBatEditor = function() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'bat-editor-modal';
            
            const currentScript = document.getElementById('bat_script').value;
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>
                            <i class="fas fa-file-code"></i>
                            Başlatma Script'i Düzenleyici
                        </h3>
                        <button class="modal-close" onclick="closeBatEditor()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Shortcut Buttons -->
                        <div class="shortcut-buttons">
                            <!-- Registry İşlemleri -->
                            <div class="shortcut-group">
                                <h4><i class="fas fa-cog"></i> Registry İşlemleri</h4>
                                <div class="button-grid">
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('reg import \\\"Z:\\\\Games\\\\GTA5\\\\registry.reg\\\"')" title="Registry dosyasını import et">
                                        <i class="fas fa-file-import"></i>
                                        <span>Import Registry</span>
                                    </button>
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('reg add \\\"HKCU\\\\Software\\\\Rockstar Games\\\\GTA V\\\" /v Language /t REG_SZ /d \\\"tr-TR\\\" /f')" title="Registry değeri ekle">
                                        <i class="fas fa-plus-circle"></i>
                                        <span>Add Registry</span>
                                    </button>
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('reg delete \\\"HKCU\\\\Software\\\\MyGame\\\" /f')" title="Registry anahtarını sil">
                                        <i class="fas fa-trash-alt"></i>
                                        <span>Delete Registry</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- MKLink İşlemleri -->
                            <div class="shortcut-group">
                                <h4><i class="fas fa-link"></i> MKLink İşlemleri</h4>
                                <div class="button-grid">
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('mklink /D \\\"%USERPROFILE%\\\\Documents\\\\MyGame\\\\Saves\\\" \\\"Z:\\\\Saves\\\\MyGame\\\"')" title="Klasör için symbolic link oluştur">
                                        <i class="fas fa-folder"></i>
                                        <span>Directory Link</span>
                                    </button>
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('mklink \\\"%APPDATA%\\\\MyGame\\\\config.ini\\\" \\\"Z:\\\\Configs\\\\config.ini\\\"')" title="Dosya için hard link oluştur">
                                        <i class="fas fa-file"></i>
                                        <span>File Link</span>
                                    </button>
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('mklink /J \\\"C:\\\\Data\\\\MyGame\\\" \\\"Z:\\\\Shared\\\\MyGame\\\"')" title="Junction oluştur">
                                        <i class="fas fa-folder-tree"></i>
                                        <span>Junction</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Dosya Kopyalama -->
                            <div class="shortcut-group">
                                <h4><i class="fas fa-copy"></i> Dosya Kopyalama</h4>
                                <div class="button-grid">
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('xcopy \\\"Z:\\\\Cache\\\\MyGame\\\" \\\"%LOCALAPPDATA%\\\\MyGame\\\" /E /I /Y')" title="Xcopy ile dosya kopyala">
                                        <i class="fas fa-clone"></i>
                                        <span>XCopy</span>
                                    </button>
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('robocopy \\\"Z:\\\\Configs\\\" \\\"C:\\\\ProgramData\\\\MyGame\\\" /MIR /R:1 /W:1')" title="Robocopy ile senkronize et">
                                        <i class="fas fa-sync"></i>
                                        <span>Robocopy</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Sistem Komutları -->
                            <div class="shortcut-group">
                                <h4><i class="fas fa-terminal"></i> Sistem Komutları</h4>
                                <div class="button-grid">
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('timeout /t 10 /nobreak >nul')" title="10 saniye bekle">
                                        <i class="fas fa-hourglass-half"></i>
                                        <span>Timeout</span>
                                    </button>
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('start \\\"\\\" \\\"D:\\\\Games\\\\Valorant\\\\VALORANT.exe\\\"')" title="Program başlat">
                                        <i class="fas fa-rocket"></i>
                                        <span>Start Program</span>
                                    </button>
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('taskkill /IM updater.exe /F')" title="Süreci zorla kapat">
                                        <i class="fas fa-power-off"></i>
                                        <span>Kill Process</span>
                                    </button>
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('echo [🚀] Oyun başlatılıyor...')" title="Mesaj göster">
                                        <i class="fas fa-comment"></i>
                                        <span>Echo Message</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Temizleme İşlemleri -->
                            <div class="shortcut-group">
                                <h4><i class="fas fa-broom"></i> Temizleme İşlemleri</h4>
                                <div class="button-grid">
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('del /q /f \\\"%TEMP%\\\\*.*\\\"')" title="Temp dosyalarını temizle">
                                        <i class="fas fa-trash"></i>
                                        <span>Delete Temp</span>
                                    </button>
                                    <button type="button" class="shortcut-btn" onclick="insertCommand('rd /s /q \\\"%LOCALAPPDATA%\\\\CrashDumps\\\"')" title="Klasörü sil">
                                        <i class="fas fa-folder-minus"></i>
                                        <span>Remove Dir</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Editor Container -->
                        <div class="editor-container">
                            <div id="bat-codemirror-container"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeBatEditor()">
                            <i class="fas fa-times"></i>
                            İptal
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveBatScript()">
                            <i class="fas fa-save"></i>
                            Kaydet
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // Initialize CodeMirror
            setTimeout(() => {
                const container = document.getElementById('bat-codemirror-container');
                batCodeMirror = CodeMirror(container, {
                    value: currentScript,
                    mode: 'shell',
                    theme: 'monokai',
                    lineNumbers: true,
                    lineWrapping: true,
                    indentUnit: 4,
                    tabSize: 4,
                    indentWithTabs: false,
                    autofocus: true,
                    styleActiveLine: true,
                    matchBrackets: true,
                    autoCloseBrackets: true
                });
                
                // Set editor height
                batCodeMirror.setSize(null, '400px');
            }, 100);
        };

        // Insert command at cursor position
        window.insertCommand = function(command) {
            if (batCodeMirror) {
                const doc = batCodeMirror.getDoc();
                const cursor = doc.getCursor();
                // Add newline before if not at start of document
                const prefix = cursor.line > 0 || cursor.ch > 0 ? '\n' : '';
                doc.replaceRange(prefix + command + '\n', cursor);
                batCodeMirror.focus();
            }
        };

        window.closeBatEditor = function() {
            const modal = document.getElementById('bat-editor-modal');
            if (modal) {
                batCodeMirror = null;
                modal.remove();
            }
        };

        window.saveBatScript = function() {
            if (batCodeMirror) {
                const editorContent = batCodeMirror.getValue();
                document.getElementById('bat_script').value = editorContent;
                closeBatEditor();
            }
        };

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('bat-editor-modal');
            if (modal && event.target === modal)

 {
                closeBatEditor();
            }
        });

        // Close modal with Escape key
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeBatEditor();
            }
        });

        // Disk selection function
        window.selectDisk = function(diskLetter) {
            // Remove selected class from all disk cards
            document.querySelectorAll('.disk-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked disk card
            const selectedCard = document.querySelector(`.disk-card[data-disk="${diskLetter}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
        };
    </script>
{% endblock %}
