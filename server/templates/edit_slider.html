{% extends 'base_admin.html' %}

{% block title %}Slider DÃ¼zenle{% endblock %}

{% block content %}
    <div class="header">
        <h1>Slider DÃ¼zenle</h1>
        <a href="{{ url_for('manage_sliders') }}" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i>
            Geri DÃ¶n
        </a>
    </div>

    <div class="form-container">
        <form method="POST" enctype="multipart/form-data">
            <div class="section-title">Slider Ä°Ã§eriÄŸi</div>
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="game_search_input">Ã–ne Ã‡Ä±karÄ±lacak Oyun:</label>
                    <div class="search-select-container">
                        {% set selected_game_name = (games|selectattr('id', 'equalto', slider.game_id)|first).oyun_adi if slider and slider.game_id else '' %}
                        <input type="text" id="game_search_input" placeholder="Oyun adÄ±nÄ± yazarak ara..." autocomplete="off" value="{{ selected_game_name }}">
                        <input type="hidden" name="game_id" id="game_id_hidden" value="{{ slider.game_id or '' }}">
                        <div id="game_search_results" class="search-select-results"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="badge_text">Rozet:</label>
                    <select name="badge_text" id="badge_text">
                        <option value="ðŸ”¥ POPÃœLER" {% if slider.badge_text == 'ðŸ”¥ POPÃœLER' %}selected{% endif %}>ðŸ”¥ POPÃœLER</option>
                        <option value="âœ¨ YENÄ° OYUN" {% if slider.badge_text == 'âœ¨ YENÄ° OYUN' %}selected{% endif %}>âœ¨ YENÄ° OYUN</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="title">BaÅŸlÄ±k:</label>
                    <input type="text" name="title" id="title" value="{{ slider.title or '' }}" required>
                </div>
                <div class="form-group full-width">
                    <label for="description">AÃ§Ä±klama:</label>
                    <textarea name="description" id="description" rows="3">{{ slider.description or '' }}</textarea>
                </div>

                <div class="form-group full-width">
                    <label for="background_image_input">Arkaplan Resmi (Ã–nerilen: 1920x1080):</label>
                    {% if slider.background_image %}
                        <p class="file-prompt">Mevcut Resim:</p>
                        <img src="{{ url_for('static', filename='images/slider/' + slider.background_image) }}" alt="Mevcut Arkaplan" class="image-preview" style="max-width: 400px; height: auto;">
                        <input type="hidden" name="current_background_image" value="{{ slider.background_image }}">
                        <p class="file-prompt">DeÄŸiÅŸtirmek iÃ§in yeni bir resim seÃ§in:</p>
                    {% endif %}
                    <div class="custom-file-input-wrapper">
                        <input type="file" name="background_image" id="background_image_input" class="file-input" accept="image/jpeg, image/png, image/webp">
                        <label for="background_image_input" class="btn btn-primary" style="padding: 10px 15px; font-size: 14px; font-weight: bold;">Dosya SeÃ§...</label>
                        <span class="file-name" id="background_image_name">Dosya seÃ§ilmedi</span>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="display_order">GÃ¶sterim SÄ±rasÄ±:</label>
                    <input type="number" name="display_order" id="display_order" value="{{ slider.display_order or 0 }}">
                </div>
                 <div class="form-group">
                    <label for="is_active">Aktif Mi?</label>
                    <input type="checkbox" name="is_active" id="is_active" {% if slider.is_active %}checked{% endif %} style="width: 20px; height: 20px;">
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                <i class="fas fa-save"></i>
                DeÄŸiÅŸiklikleri Kaydet
            </button>
        </form>
    </div>

     <script>
        const games = [
            {% for game in games %}
                { id: {{ game.id }}, name: {{ game.oyun_adi|tojson }} },
            {% endfor %}
        ];

        const gameSearchInput = document.getElementById('game_search_input');
        const gameIdHidden = document.getElementById('game_id_hidden');
        const searchResults = document.getElementById('game_search_results');

        gameSearchInput.addEventListener('input', () => {
            const searchTerm = gameSearchInput.value.toLowerCase();
            searchResults.innerHTML = '';
            
            // Arama kutusu her deÄŸiÅŸtiÄŸinde, eÄŸer seÃ§ili oyunla eÅŸleÅŸmiyorsa seÃ§imi temizle
            if (games.find(g => g.name.toLowerCase() === searchTerm)?.id != gameIdHidden.value) {
                gameIdHidden.value = '';
            }

            if (searchTerm.length === 0) {
                searchResults.style.display = 'none';
                return;
            }

            const filteredGames = games.filter(game => game.name.toLowerCase().includes(searchTerm));
            
            if (filteredGames.length > 0) {
                filteredGames.forEach(game => {
                    const item = document.createElement('div');
                    item.textContent = game.name;
                    item.dataset.id = game.id;
                    item.addEventListener('click', () => {
                        gameSearchInput.value = game.name;
                        gameIdHidden.value = game.id;
                        searchResults.style.display = 'none';
                    });
                    searchResults.appendChild(item);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-select-container')) {
                searchResults.style.display = 'none';
            }
        });

        document.getElementById('background_image_input').addEventListener('change', (event) => {
            const fileNameSpan = document.getElementById('background_image_name');
            fileNameSpan.textContent = event.target.files.length > 0 ? event.target.files[0].name : 'Dosya seÃ§ilmedi';
        });
    </script>
{% endblock %}